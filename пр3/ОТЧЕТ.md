# Отчёт по практической работе №3

## Тема
Построение MVC-архитектуры и выполнение CRUD-операций в Spring Boot приложении с использованием PostgreSQL

## Цель работы
Отработать реализацию MVC-архитектуры и CRUD-операций в Spring Boot приложении для создания полнофункционального веб-приложения с управлением сущностями. Закрепить навыки работы с различными типами связей в БД.

## Предметная область
Система управления библиотекой

## Реализованные сущности (5 связанных таблиц)

### 1. Author (Автор)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Первичный ключ |
| firstName | String | Имя автора |
| lastName | String | Фамилия автора |
| birthDate | LocalDate | Дата рождения |
| country | String | Страна |
| biography | String | Биография |

**Связь:** OneToMany с Book

### 2. Publisher (Издательство)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Первичный ключ |
| name | String | Название |
| address | String | Адрес |
| city | String | Город |
| country | String | Страна |
| email | String | Email |
| phone | String | Телефон |

**Связь:** OneToMany с Book

### 3. Genre (Жанр)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Первичный ключ |
| name | String | Название жанра |
| description | String | Описание |

**Связь:** ManyToMany с Book

### 4. Book (Книга)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Первичный ключ |
| title | String | Название книги |
| isbn | String | ISBN |
| publicationYear | Integer | Год издания |
| pages | Integer | Количество страниц |
| description | String | Описание |
| price | BigDecimal | Цена |
| totalCopies | Integer | Всего копий |
| availableCopies | Integer | Доступно копий |

**Связи:**
- ManyToOne с Author
- ManyToOne с Publisher
- ManyToMany с Genre
- OneToMany с BookLoan

### 5. BookLoan (Выдача книги)
| Поле | Тип | Описание |
|------|-----|----------|
| id | Long | Первичный ключ |
| readerName | String | Имя читателя |
| readerEmail | String | Email читателя |
| readerPhone | String | Телефон |
| loanDate | LocalDate | Дата выдачи |
| dueDate | LocalDate | Срок возврата |
| returnDate | LocalDate | Дата возврата |
| status | LoanStatus | Статус (ACTIVE, RETURNED, OVERDUE) |
| notes | String | Примечания |

**Связь:** ManyToOne с Book

## Архитектура MVC

### Model (Модель)
Сущности расположены в пакете `com.library.model`:
- `Author.java`
- `Publisher.java`
- `Genre.java`
- `Book.java`
- `BookLoan.java`

### View (Представление)
Thymeleaf-шаблоны в директории `resources/templates/`:
- `index.html` — главная страница
- `books/` — шаблоны для книг (list, form, view)
- `authors/` — шаблоны для авторов
- `publishers/` — шаблоны для издательств
- `genres/` — шаблоны для жанров
- `loans/` — шаблоны для выдач книг

### Controller (Контроллер)
Контроллеры в пакете `com.library.controller`:
- `HomeController.java`
- `BookController.java`
- `AuthorController.java`
- `PublisherController.java`
- `GenreController.java`
- `BookLoanController.java`

## Валидация данных

Использованы аннотации валидации:

```java
// Author.java
@NotBlank(message = "Имя автора обязательно")
@Size(min = 2, max = 100, message = "Имя должно быть от 2 до 100 символов")
private String firstName;

@Past(message = "Дата рождения должна быть в прошлом")
private LocalDate birthDate;

// Book.java
@NotBlank(message = "Название книги обязательно")
@Size(min = 1, max = 300)
private String title;

@Min(value = 1000, message = "Год издания должен быть не ранее 1000")
@Max(value = 2100, message = "Год издания должен быть не позднее 2100")
private Integer publicationYear;

@DecimalMin(value = "0.00", message = "Цена не может быть отрицательной")
@Digits(integer = 8, fraction = 2)
private BigDecimal price;

// Publisher.java
@Email(message = "Некорректный email")
private String email;

@Pattern(regexp = "^[+]?[0-9\\-\\s()]*$", message = "Некорректный номер телефона")
private String phone;
```

## CRUD-операции

| Операция | Метод HTTP | URL пример | Описание |
|----------|-----------|------------|----------|
| Create | POST | /books | Создание новой книги |
| Read | GET | /books, /books/{id} | Список и просмотр |
| Update | POST | /books/{id} | Обновление книги |
| Delete | POST | /books/{id}/delete | Удаление книги |

## Фильтрация и сортировка

### Фильтрация книг
```java
@Query("SELECT DISTINCT b FROM Book b " +
       "LEFT JOIN b.author a " +
       "LEFT JOIN b.publisher p " +
       "LEFT JOIN b.genres g " +
       "WHERE (:title IS NULL OR LOWER(b.title) LIKE LOWER(CONCAT('%', :title, '%'))) " +
       "AND (:authorId IS NULL OR a.id = :authorId) " +
       "AND (:publisherId IS NULL OR p.id = :publisherId) " +
       "AND (:genreId IS NULL OR g.id = :genreId) " +
       "AND (:yearFrom IS NULL OR b.publicationYear >= :yearFrom) " +
       "AND (:yearTo IS NULL OR b.publicationYear <= :yearTo)")
List<Book> findByFilters(...);
```

### Сортировка
- По названию (А-Я, Я-А)
- По году издания
- По цене
- По автору/издательству

## Множественное удаление с проверкой связей

### Проверка связей перед удалением
```java
@PostMapping("/delete-multiple")
public String deleteMultiple(@RequestParam("ids") List<Long> ids,
                             RedirectAttributes redirectAttributes) {
    StringBuilder errors = new StringBuilder();
    int deleted = 0;
    
    for (Long id : ids) {
        // Проверка наличия связанных записей
        if (authorService.hasBooks(id)) {
            Author author = authorService.findById(id).orElse(null);
            if (author != null) {
                errors.append(author.getFullName())
                      .append(" (").append(authorService.countBooks(id)).append(" книг), ");
            }
        } else {
            authorService.delete(id);
            deleted++;
        }
    }
    
    if (errors.length() > 0) {
        redirectAttributes.addFlashAttribute("error", 
            "Не удалось удалить авторов с книгами: " + errors);
    }
    if (deleted > 0) {
        redirectAttributes.addFlashAttribute("success", "Удалено авторов: " + deleted);
    }
    
    return "redirect:/authors";
}
```

### Проверка в репозитории
```java
@Query("SELECT COUNT(b) > 0 FROM Book b WHERE b.author.id = :authorId")
boolean hasBooks(@Param("authorId") Long authorId);

@Query("SELECT COUNT(l) > 0 FROM BookLoan l WHERE l.book.id = :bookId AND l.status = 'ACTIVE'")
boolean hasActiveLoans(@Param("bookId") Long bookId);
```

## Типы связей в БД

| Связь | Тип | Реализация |
|-------|-----|------------|
| Author → Book | OneToMany | `@OneToMany(mappedBy = "author")` |
| Publisher → Book | OneToMany | `@OneToMany(mappedBy = "publisher")` |
| Book → Genre | ManyToMany | `@JoinTable(name = "book_genres")` |
| Book → BookLoan | OneToMany | `@OneToMany(mappedBy = "book")` |

## Используемые технологии

- **Spring Boot 3.2** — фреймворк
- **Spring Data JPA** — работа с БД
- **PostgreSQL / H2** — база данных
- **Thymeleaf** — шаблонизатор
- **Bean Validation** — валидация данных
- **Maven** — сборка проекта

## Вывод

В ходе выполнения работы было создано полнофункциональное веб-приложение «Система управления библиотекой» с использованием Spring Boot и PostgreSQL. Реализована MVC-архитектура с разделением на Model (5 связанных сущностей), View (Thymeleaf-шаблоны) и Controller (обработка HTTP-запросов).

Созданы 5 связанных сущностей: Author, Publisher, Genre, Book и BookLoan с различными типами связей (OneToMany, ManyToOne, ManyToMany). Реализованы полные CRUD-операции для всех сущностей с валидацией данных при помощи аннотаций `@NotBlank`, `@Size`, `@Min`, `@Max`, `@Email`, `@Pattern`, `@Past`, `@DecimalMin`.

Добавлена фильтрация по множеству параметров (название, автор, издательство, жанр, год издания) и сортировка. Реализовано множественное удаление с проверкой корректности связей — система не позволяет удалить автора, у которого есть книги, или книгу с активными выдачами.

Использованы аннотации: `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToOne`, `@OneToMany`, `@ManyToMany`, `@JoinTable`, `@JoinColumn`, `@Controller`, `@Service`, `@Repository`, `@GetMapping`, `@PostMapping`, `@RequestParam`, `@PathVariable`, `@Valid`, `@ModelAttribute`.

